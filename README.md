# 基于 FPGA 的实时连通域分析 (CCL)

本项目使用 Verilog 语言实现了一个用于 FPGA 的实时连通域分析（Connected Component Labeling, CCL）算法。该设计旨在处理实时的二进制图像数据流，识别不同的连通区域（blobs），并实时计算它们的属性，例如面积和质心坐标 (x, y)。

该实现采用单遍扫描（single-pass）算法，并结合一个等效表（基于并查集/Union-Find数据结构）来高效地处理标签合并，使其非常适用于高吞吐量的视频处理应用。

## 功能特性

-   **实时处理:** 使用标准的视频流信号（`vsync`, `href`）对像素数据进行在线处理。
-   **单遍扫描算法:** 利用对图像的单次遍历和并查集等效表来保证高效率。
-   **连通域属性分析:** 可为每个检测到的连通分量计算以下属性：
    -   面积（像素总数）
    -   质心（x 和 y 坐标）
-   **参数可配置:** 图像的尺寸（`WIDTH`, `HEIGH`）和最大标签数量（`RAM_DEPTH`）都可以通过 Verilog 的 `parameter` 轻松配置。
-   **模块化设计:** 项目被清晰地划分为主逻辑、RAM模块和等效表等多个逻辑模块。

## 硬件架构

该设计采用流水线式的流处理架构，每个时钟周期处理一个像素。

1.  **输入同步:** 输入的视频信号（`per_img_vsync`, `per_img_href`, `per_img_bit`）通过一系列寄存器进行延迟，以生成流水线所需的同步版本。这对齐当前像素与其邻域数据以及其他流水线阶段至关重要。

2.  **坐标生成:** 设计中使用水平计数器（`hcnt`）和垂直计数器（`vcnt`）来跟踪当前像素在帧内的坐标。

3.  **标记核心逻辑:** 算法的核心部分通过检查当前前景像素的4-连通邻域（左、上、左上、右上）来决定其标签。
    -   如果没有邻居是前景像素，则从一个全局的 `cnt_label` 计数器分配一个新标签。
    -   如果一个或多个邻居是前景像素，则将它们中最小的标签分配给当前像素。

4.  **行缓存 (Line Buffer):** 一个 `Simple_dual_port_RAM` 实例被用作行缓存，用于存储上一行像素的标签。这些标签是进行“上”、“左上”和“右上”邻域检查所必需的。

5.  **等效性解析 (并查集):** 当一个像素连接了两个之前被认为是独立的区域时，就会发生标签冲突。此时，所有邻居的标签都会被发送到 `equivalence_table` 模块。该模块维护一个并查集数据结构，通过 `union_req` 信号来记录这些不同的标签实际上是等效的，属于同一个对象。

6.  **实时属性计算:** 在为每个像素分配标签的同时，该像素对其所在对象的属性贡献也会被实时计算，并存储在以其标签（`cur_label`）为地址的RAM中。
    -   **分母 (面积):** 每个被标记的像素，其对应标签的面积计数值加一。
    -   **分子 X/Y (用于计算质心):** 像素的 x (`hcnt_5dly`) 和 y (`vcnt_5dly`) 坐标被累加到对应标签的累加器中。

7.  **帧末处理:** 在整帧图像处理完毕后（在 `per_img_vsync` 的下降沿触发），一个后处理阶段（`acc_process`）会启动。
    -   它会遍历所有使用过的标签。
    -   对于每个标签，它会查询 `equivalence_table` 以找到其最终的“根标签”。
    -   然后，它将每个标签的属性（面积、分子X、分子Y）累加到其对应的根标签中。这个过程整合了所有被合并区域的属性。

8.  **输出生成:** 累加完成后，最终结果将以流的形式输出。`ready_output` 信号会置为有效，并且每个有效连通分量的 `ccl_index`, `area`, `x`, `y` 将会依次出现在输出端口上。质心坐标是通过将分子累加值除以面积计算得出的。

## 模块描述

| 文件名                    | 描述                                                                                              |
| ------------------------- | ------------------------------------------------------------------------------------------------- |
| `CCL.v`                   | 顶层模块，集成了所有子模块，并实现了主要的CCL流水线和处理逻辑。                              |
| `Simple_dual_port_RAM.v`  | 一个通用的、Block RAM 风格的简单双口RAM。用于行缓存和存储标签属性。                    |
| `equivalence_table.v`     | 实现了并查集算法，用于管理标签的等效关系，并为任意给定标签找到其根标签。 |
| `mark_label.v`            | `CCL` 模块的一个变体，设计用于处理8位灰度图像数据，而非二进制数据。                            |
| `testbench.sv`            | 用于仿真 `CCL` 模块的 SystemVerilog 测试平台。                                           |

## 顶层模块参数 (`CCL.v`)

您可以通过修改这些参数来为不同的图像尺寸定制模块：

| 参数名      | 描述                                                       | 默认值 |
| ----------- | ---------------------------------------------------------- | ------ |
| `RAM_DEPTH` | 单帧图像中可以标记的独立连通分量的最大数量。           | 255    |
| `WIDTH`     | 输入图像的宽度（单位：像素）。                           | 10     |
| `HEIGH`     | 输入图像的高度（单位：像素）。                           | 10     |

## 接口 (`CCL.v`)

### 输入端口

| 端口名            | 描述                                                                    |
| ----------------- | ----------------------------------------------------------------------- |
| `clk`             | 系统时钟。                                                      |
| `per_img_vsync`   | 垂直同步信号。在有效图像帧期间为高电平。                          |
| `per_img_href`    | 水平参考信号。在每行有效像素期间为高电平。                      |
| `per_img_bit`     | 1位的二进制输入像素数据（1代表前景，0代表背景）。 |

### 输出端口

| 端口名            | 描述                                                                                      |
| ----------------- | ----------------------------------------------------------------------------------------- |
| `post_img_vsync`  | 与输出像素流同步的、延迟后的 `vsync` 信号。                                      |
| `post_img_href`   | 与输出像素流同步的、延迟后的 `href` 信号。                                       |
| `post_img_bit`    | 延迟后的像素数据输出。                                                           |
| `ccl_index`       | 当前输出数据的连通分量索引（例如：1, 2, 3...）。                             |
| `area`            | 由 `ccl_index` 指示的连通分量的计算面积（单位：像素）。             |
| `x`               | 该连通分量质心的 x 坐标计算结果。                                          |
| `y`               | 该连通分量质心的 y 坐标计算结果。                                          |
| `ready_output`    | 标志信号。当一帧处理完毕，且 `ccl_index`, `area`, `x`, `y` 输出有效数据时，此信号为高电平。 |

## 仿真

项目包含一个 SystemVerilog 测试平台 `testbench.sv`，用于验证 `CCL` 模块的功能。

### 如何运行

1.  **准备输入图像:** 测试平台会从一个名为 `img_Bin.dat` 的文本文件中读取二进制图像。该文件应包含十六进制格式的像素值（0或1），每行一个像素。对于一个10x10的图像，该文件将包含100行。

    **一个简单的10x10图像 `img_Bin.dat` 示例:**
    ````
    00
    00
    00
    01
    01
    01
    00
    00
    00
    00
    // ... (重复直到100个像素)
    ````

2.  **运行仿真:** 在您偏好的HDL仿真器（如 Vivado Simulator, ModelSim, Verilator等）中，编译所有的Verilog源文件（`CCL.v`, `Simple_dual_port_RAM.v`, `equivalence_table.v`）以及 `testbench.sv` 文件。

3.  **观察输出:** 在波形查看器中监控输出信号 `ccl_index`, `area`, `x`, `y` 和 `ready_output`。在每一帧处理完毕后，`ready_output` 会变高，并且每个检测到的目标的计算属性会依次显示在输出端口上。

## 验证

使用项目中matlab文件夹下的代码进行验证，观察命令行窗口输出的连通域个数以及连通域的中心坐标是否和Verilog仿真输出一致。

## 文件目录
